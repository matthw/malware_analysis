rule brc4_stage1
{
    meta:
        author = "@matth_walter"
        description = "identify BRC4 stagers"
    strings:
        /* 
         * 91AFCA54=VirtualAlloc
         * 7946C61B=VirtualProtect
         * CA2BD06B=CreateThread
         * CE05D9AD=WaitForSingleObject
         */
        $api_v1_a = { 41 b8 54 ca af 91 }
        $api_v1_b = { 41 b8 1b c6 46 79 }
        $api_v1_c = { 41 b8 6b d0 2b ca }
        $api_v1_d = { 41 b8 ad d9 05 ce }
        /*
         * 6E1A959C=VirtualAllocEx
         * D83D6AA1=WriteProcessMemory
         * 72BD9CDD=CreateRemoteThread
         * CE05D9AD=WaitForSingleObject
         */
        $api_v2_a = { 41 b8 9c 95 1a 6e }
        $api_v2_b = { 41 b8 a1 6a 3d d8 }
        $api_v2_c = { 41 b8 dd 9c bd 72 }
        $api_v2_d = { 41 b8 ad d9 05 ce }
        /*
         * d33bcabd=NtAllocateVirtualMemory
         * 8c394d89=NtProtectVirtualMemory
         * 4d1deb74=NtCreateThreadEx
         * ae06c1b2=NtWaitForSingleObject
         */
        $api_v3_a = { 41 b8 bd ca 3b d3 }
        $api_v3_b = { 41 b8 89 4d 39 8c }
        $api_v3_c = { 41 b8 74 eb 1d 4d }
        $api_v3_d = { 41 b8 b2 c1 06 ae }

        /*
         * PE header push
         */
        $pe_push = { 48 b8 0e 1f ba 0e 00 b4 09 cd 50 48 b8 00 00 00 00 80 00 00 00 50 b8 00 00 00 00 50 b8 00 00 00 00 50 b8 00 00 00 00 50 b8 40 00 00 00 50 b8 b8 00 00 00 50 48 b8 04 00 00 00 ff ff 00 00 50 }

    condition:
        (all of ($api_v1_*) or all of ($api_v2_*) or all of ($api_v3_*)) and $pe_push
}
