# BRC4 Unpacker

Unpack Brute Ratel (BRC4) stager and extract config

also tries to find the rc4 key in case of encrypted config

```
% python brc4_unpack.py 3ad53495851bafc48caf6d2227a434ca2e0bef9ab3bd40abfe4ea8f318d37bbe.exe
entry_point: 0x401000 (raw: 0x200)
searching for tail jump...
tail jump -> 0x43ecb2:	jmp	0x43ee4f
emulating from entry to tail jump...
dumped stage 2 to 3ad53495851bafc48caf6d2227a434ca2e0bef9ab3bd40abfe4ea8f318d37bbe.exe.stage2
config:
 - '0'
 - '1'
 - '159.65.186.50'
 - '443'
 - 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36'
 - '2K4TBS7L9GK2C205'
 - '306TU1OE6RDT9SR1'
 - '/login,/admin'
 - ''
 - ''

% python brc4_unpack.py d71dc7ba8523947e08c6eec43a726fe75aed248dfd3a7c4f6537224e9ed05f6f.exe
entry_point: 0x401000 (raw: 0x200)
searching for tail jump...
tail jump -> 0x41b5d8:	jmp	0x41b765
emulating from entry to tail jump...
dumped stage 2 to d71dc7ba8523947e08c6eec43a726fe75aed248dfd3a7c4f6537224e9ed05f6f.exe.stage2
config:
 - '0'
 - '45.77.172.28'
 - '80'
 - 'trial@deloitte.com.cn'
 - 'Password123'
 - 'abcd@123'
 - '/content.php'
 - ''
 - ''

% python brc4_unpack.py dd8652e2dcfe3f1a72631b3a9585736fbe77ffabee4098f6b3c48e1469bf27aa
entry_point: 0x401000 (raw: 0x200)
searching for tail jump...
tail jump -> 0x44445a:	jmp	0x4446c5
emulating from entry to tail jump...
dumped stage 2 to dd8652e2dcfe3f1a72631b3a9585736fbe77ffabee4098f6b3c48e1469bf27aa.stage2
building cfg...
finding rc4...
found potential rc4 code: 0x61f87500
skip 0x1643688176: too few predecessors (2) / unlikely to be rc4
trying key b'bYXJm/3#M?:XyMBF'
config:
 - ''
 - ''
 - '0'
 - '1'
 - '192.168.2.9'
 - '443'
 - 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36'
 - '12345'
 - 'P@ssw0rd'
 - '/admin'
 - ''
 - ''

```

2nd stage payloads are extracted too:
```
% file *.stage2
3ad53495851bafc48caf6d2227a434ca2e0bef9ab3bd40abfe4ea8f318d37bbe.exe.stage2: PE32+ executable (DLL) (console) x86-64 (stripped to external PDB), for MS Windows
d71dc7ba8523947e08c6eec43a726fe75aed248dfd3a7c4f6537224e9ed05f6f.exe.stage2: PE32+ executable (DLL) (console) x86-64 (stripped to external PDB), for MS Windows
dd8652e2dcfe3f1a72631b3a9585736fbe77ffabee4098f6b3c48e1469bf27aa.stage2: PE32+ executable (DLL) (console) x86-64 (stripped to external PDB), for MS Windows
```
